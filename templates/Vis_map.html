<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>KBO 구장 지도</title>
  <style>
    /* ---- 페이지 공통 ---- */
    body { background: #f5f6fa; font-family: 'Noto Sans KR', sans-serif; margin: 0; }

    /* ---- 상단 배너(지도는 건드리지 않음) ---- */
    .header {
      background: transparent;           /* 상단 전체 배경 제거 */
      padding: 24px 16px 8px;            /* 바깥 여백 */
    }
    .top-banner {
      max-width: 880px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid #e9eef5;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(16, 24, 40, 0.06);
      padding: 16px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .banner-title {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .banner-title h1 {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }
    .banner-title p {
      font-size: 13px;
      color: #6b7280;
      margin: 0;
    }
    .banner-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .banner-label {
      font-size: 13px;
      color: #374151;
      font-weight: 600;
    }
    .banner-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
      background: #ffffff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
      transition: border-color .2s, box-shadow .2s;
    }
    .banner-select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 4px rgba(26,115,232,0.12);
    }

    /* ---- 지도(기존 스타일 유지) ---- */
    .map-container { position: relative; width: 800px; height: 1000px; margin: 40px auto; }
    .korea-map { width: 100%; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.15); display: block; }

    /* ---- 마커(기존 톤 유지) ---- */
    .team-marker {
      position: absolute;
      min-width: 40px;
      background: white;
      border: 2px solid #1a73e8;
      border-radius: 10px;
      font-size: 13px;
      padding: 4px 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-align: center;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      z-index: 2;
    }
    .team-marker:hover { background: #1a73e8; color: white; transform: translate(-50%, -50%) scale(1.1); }

    .footer { text-align: center; padding: 20px; color: #666; }
  </style>
</head>
<body>
  <!-- 상단 배너만 카드형으로 변경 -->
  <div class="header">
    <div class="top-banner">
      <div class="banner-title">
        <h1>KBO 구장 지도</h1>
        <p>구장을 클릭하여 입장하세요</p>
      </div>

      <!-- 서버에서 전달된 selected_team (보이지 않음) -->
      <div id="server-data" data-selected-team="{{ selected_team|default('') }}" style="display:none;"></div>

      <div class="banner-actions">
        <label for="team-select" class="banner-label">팀 선택</label>
        <select id="team-select" class="banner-select"></select>
      </div>
    </div>
  </div>

  <!-- 지도 영역은 그대로 유지 -->
  <div class="map-container">
    <img src="static/kr.svg" alt="Korea Map" class="korea-map" />
    <div id="markers"></div>
  </div>

  <div class="footer">
    <p>📊 실시간 KBO 데이터와 함께 야구장을 체험해보세요!</p>
  </div>

  <script>
    // 서버 주입값 / URL / localStorage 우선순위
    const serverEl = document.getElementById('server-data');
    const serverTeam = serverEl && serverEl.dataset.selectedTeam ? serverEl.dataset.selectedTeam : '';
    const urlTeam = (new URLSearchParams(window.location.search)).get('team') || '';
    let selectedTeam = serverTeam || urlTeam || localStorage.getItem('kbo_selected_team') || null;

    // 공백/보이지 않는 문자 정리
    const INVIS_RE = /[\s\u00A0\u200B-\u200D\u202F\uFEFF]+/g;
    const clean = s => (s || '').toString().replace(INVIS_RE, '');

    // 표시명 → 정식 구장명
    const STADIUM_ALIASES = {
      "잠실": "잠실",
      "고척": "고척",
      "문학": "문학",
      "수원": "수원",
      "대전": "대전",
      "대구": "대구",
      "광주": "광주",
      "창원": "창원",
      "울산": "울산",
      "사직": "사직",
      "포항": "포항"
    };

    function populateTeams() {
      fetch('/api/teams').then(r => r.json()).then(list => {
        const sel = document.getElementById('team-select');
        sel.innerHTML = '';
        list.forEach((t) => {
          const opt = document.createElement('option');
          opt.value = t; opt.text = t;
          sel.appendChild(opt);
        });

        if (!selectedTeam) selectedTeam = sel.options.length ? sel.options[0].value : 'LG';

        // 드롭다운 선택 반영
        for (let i = 0; i < sel.options.length; i++) {
          if (sel.options[i].value === selectedTeam) { sel.selectedIndex = i; break; }
        }

        sel.addEventListener('change', function () {
          selectedTeam = this.value;
          try { localStorage.setItem('kbo_selected_team', selectedTeam); } catch (e) {}
        });

        // 팀 목록 준비 후 마커 생성
        createMarkers();
      }).catch(() => {
        // 실패 시 최소값 보장
        const sel = document.getElementById('team-select');
        if (sel && sel.options.length === 0) {
          const opt = document.createElement('option');
          opt.value = 'LG'; opt.text = 'LG'; sel.appendChild(opt);
          selectedTeam = 'LG';
        }
        createMarkers();
      });
    }

    function createMarkers() {
      const markersContainer = document.getElementById("markers");
      markersContainer.innerHTML = ''; // 중복 방지

      // ✅ 잠실: 기존 140px, 165px의 중간값(≈152.5) → 153px로 통일해 단일 마커
      const stadiums = [
        { name: "잠실", team: "LG/두산", top: 153, left: 340 },   // 하나로 합침 (중앙 위치)
        { name: "고척", team: "키움", top: 180, left: 310 },
        { name: "문학", team: "SSG",  top: 200, left: 280 },
        { name: "수원", team: "KT",   top: 225, left: 320 },
        { name: "대전", team: "한화", top: 350, left: 390 },
        { name: "대구", team: "삼성", top: 420, left: 490 },
        { name: "광주", team: "KIA",  top: 510, left: 300 },
        { name: "창원", team: "NC",   top: 500, left: 480 },
        { name: "울산", team: "NC",   top: 520, left: 470 },
        { name: "사직", team: "롯데", top: 510, left: 540 },
        { name: "포항", team: "삼성", top: 430, left: 520 }
      ];

      const getCurrentTeam = () => document.getElementById('team-select').value || 'LG';

      stadiums.forEach(s => {
        const marker = document.createElement("div");
        marker.className = "team-marker";
        marker.style.top = `${s.top}px`;
        marker.style.left = `${s.left}px`;
        marker.innerText = s.name;

        marker.addEventListener('click', () => {
          const team = clean(getCurrentTeam() || s.team);
          const display = clean(s.name);
          const canonical = clean(STADIUM_ALIASES[display] || display);
          const url = `/stadium/${encodeURIComponent(canonical)}/chart?team=${encodeURIComponent(team)}`;
          window.location.href = url;
        });

        markersContainer.appendChild(marker);
      });
    }

    // 초기화
    populateTeams();
  </script>
</body>
</html>
